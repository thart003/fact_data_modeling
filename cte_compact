WITH yesterday AS (
  SELECT * FROM taylorhart.web_users_cumulated
  WHERE date = DATE('2022-12-31')
),
today AS (

  SELECT user_id, date_trunc('day', event_time) as event_date, DATE('2023-01-01') as partition_date, COUNT(1) FROM taylorhart.web_events
  WHERE date_trunc('day', event_time) = DATE('2023-01-01')
  GROUP BY user_id, date_trunc('day', event_time)
)

SELECT COALESCE(y.user_id, t.user_id) as user_id,
  CASE WHEN y.dates_active IS NOT NULL THEN ARRAY(t.event_date) || y.dates_active
  ELSE ARRAY(t.event_date)
  END as dates_active

FROM yesterday y FULL OUTER JOIN today t ON y.user_id = t.user_id

)
