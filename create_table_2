CREATE TABLE taylorhart.daily_web_metrics (
  user_id BIGINT,
  metric_name VARCHAR,
  metric_value BIGINT,
  date DATE
) WITH (
  format = 'PARQUET',
  partitioning = ARRAY['metric_name', 'date']
)



INSERT INTO taylorhart.daily_web_metrics

SELECT 
  user_id,
  'visited_home_page' as metric_name,
  COUNT(CASE WHEN url = '/' THEN 1 END) as metric_value,
  CAST(event_time AS DATE) as date
FROM taylorhart.web_events
GROUP BY user_id, CAST(event_time AS DATE)


CREATE TABLE taylorhart.monthly_array_metrics (
  user_id BIGINT,
  metric_name VARCHAR,
  metric_array ARRAY(INTEGER),
  month_start VARCHAR
) WITH (
  format = 'PARQUET',
  partitioning = ARRAY['metric_name', 'month_start']
)

WITH yesterday AS (
  SELECT * FROM taylorhart.monthly_array_web_metrics
  WHERE month_start = DATE('2023-08-01')
),
today AS (
  SELECT * FROM taylorhart.daily_web_metrics
  WHERE date = '2023-08-01'
)

SELECT 
  COALESCE(t.user_id, y.user_id) AS user_id,
  COALESCE(t.metric_name, y.metric_name) AS metric_name,
  COALESCE(y.metric_array, REPEAT(null, CAST(DATE_DIFF('day', DATE('2023-08-01'), t.date) AS INTEGER))) || ARRAY(t.metric_value) AS metric_array
  '2023-08-01' AS month_start
FROM 
  today t
  FULL OUTER JOIN yesterday y ON t.user_id = y.user_id AND t.metric_name = y.metric_name
  AND t.metric_name = y.metric_name
WHERE
  CARDINALITY(
    COALESCE(y.metric_array, ARRAY[]) || ARRAY(t.metric_value)
  ) = 1




